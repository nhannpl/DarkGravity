<div class="reader-container">
  <div *ngIf="loading()" class="reader-skeleton fade-in">
    <div class="skeleton-title glass"></div>
    <div class="skeleton-line glass"></div>
    <div class="skeleton-line glass"></div>
    <div class="skeleton-line glass"></div>
  </div>

  <article *ngIf="!loading() && story()" class="story-trace fade-in">
    <header class="reader-header">
      <a routerLink="/" class="back-link">← RETURN TO FEED</a>
      
      <div class="metadata-bar">
        <span class="scary-tag" [attr.data-level]="getScaryLevel(story()!.scaryScore)">
          {{ getScaryLevel(story()!.scaryScore) }} ANOMALY
        </span>
        <span class="separator">/</span>
        <span class="author-tag">TRANSIMITTED BY: {{ story()!.author }}</span>
        <span class="separator">/</span>
        <span class="date-tag">{{ story()!.fetchedAt | date:'HH:mm:ss MMMM d, yyyy' }}</span>
      </div>

      <h1 class="story-title">{{ story()!.title }}</h1>
<div class="header-actions">
  <a [href]="story()!.url" target="_blank" class="source-link">
    <span class="source-tag" [attr.data-source]="getStorySource(story()!.url)">
      VIEW ORIGINAL ON {{ getStorySource(story()!.url) }} ↗
    </span>
  </a>
  <button class="action-btn-small glass">
    <span class="icon">★</span> SAVE TO SHADOWS
  </button>
</div>
    </header>

    <div class="ai-analysis-box glass">
      <div class="analysis-header">
        <span class="ai-icon">✧</span>
        AI INSIGHT (SOCRATES LITE)
      </div>
      <div class="analysis-text" [innerHTML]="story()!.aiAnalysis | markdown"></div>
      <div class="score-grid">
        <div class="score-item">
          <span class="label">SCARY SCORE</span>
          <span class="value">{{ story()!.scaryScore }}/10</span>
        </div>
        <div class="score-bar-container">
          <div class="score-bar" [style.width.%]="story()!.scaryScore * 10"></div>
        </div>
      </div>
    </div>

    <div *ngIf="videoEmbedUrl()" class="video-embed-container glass fade-in">
      <div class="video-wrapper">
        <iframe [src]="videoEmbedUrl()" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
        </iframe>
      </div>
    </div>
    
    <div class="transcript-toggle" [class.open]="isTranscriptOpen()">
      <div class="content-label" (click)="toggleTranscript()">
        <span class="label-icon">▤</span>
        {{ getStorySource(story()!.url) === 'YOUTUBE' ? 'DECRYPTED TRANSCRIPT' : 'ARCHIVED STORY LOG' }}
        <span class="dropdown-arrow">{{ isTranscriptOpen() ? '▼' : '▶' }}</span>
      </div>
<div class="tts-toolbar fade-in" *ngIf="isTranscriptOpen()">
  <!-- Settings Panel -->
  <div class="tts-settings glass">
    <div class="setting-group grow">
      <label>VOICE MODULE</label>
      <select (change)="onVoiceChange($event)" class="voice-select">
        <option *ngFor="let voice of tts.voices()" [value]="voice.name"
          [selected]="voice.name === tts.selectedVoice()?.name">
          {{ voice.name }}
        </option>
      </select>
    </div>
    <div class="setting-group shrink">
      <label>Speech Speed</label>
      <div class="slider-wrapper">
        <input type="range" min="0.5" max="2.0" step="0.1" [value]="tts.rate()" (input)="onRateChange($event)"
          class="rate-slider">
        <input type="number" min="0.5" max="2.0" step="0.1" [value]="tts.rate()" (input)="onRateChange($event)"
          class="rate-number-input">
      </div>
    </div>
  </div>

  <div class="tts-controls">
    <button *ngIf="!tts.isPlaying()" (click)="readStory()" class="tts-btn glass" title="Listen to Trace">
      <span class="icon">▶</span> LISTEN TO TRACE
    </button>

    <ng-container *ngIf="tts.isPlaying()">
      <div class="control-group">
        <button *ngIf="!tts.isPaused()" (click)="pauseStory()" class="tts-btn glass icon-only" title="Pause">
          <span class="icon">⏸</span>
        </button>
        <button *ngIf="tts.isPaused()" (click)="resumeStory()" class="tts-btn glass icon-only" title="Resume">
          <span class="icon">▶</span>
        </button>

        <div class="tts-seeker-container">
          <input type="range" class="tts-seeker" [value]="tts.progress()" (change)="onSeek($event)" (mousedown)="onSeekStart()"
            (touchstart)="onSeekStart()" min="0" max="100" step="0.1">
          <div class="seeker-track">
            <div class="seeker-fill" [style.width.%]="tts.progress()"></div>
          </div>
          </div>
          <span class="time-display">{{ formatTime(tts.currentTime()) }} / {{ formatTime(tts.estimatedDuration()) }}</span>
          <button (click)="stopStory()" class="tts-btn glass stop-btn icon-only" title="Stop">
            <span class="icon">⏹</span>
          </button>
          </div>
          </ng-container>
          </div>
          </div>
    </div>
    
    <section class="story-body" *ngIf="isTranscriptOpen()">
      <div class="chunk-container">
        <ng-container *ngFor="let chunk of tts.chunks(); let i = index">
          <span class="chunk-span clickable-chunk" [class.active-chunk]="i === tts.currentChunkIndex()"
            [innerHTML]="getHighlightedChunk(chunk, i)" (click)="skipToChunk(i)" title="Click to read from here"></span>
          <!-- Insert a space after each chunk to prevent crowded text-->
          <span class="chunk-spacer"> </span>
          <!-- If the chunk ended in a newline, we verify if visual break is needed, 
                                  but CSS white-space: pre-wrap handles it automatically if the newline is in the text -->
        </ng-container>
      </div>
    </section>

    <footer class="reader-footer">
      <div class="trace-end">END OF TRACE</div>
    </footer>
  </article>

  <div *ngIf="!loading() && !story()" class="error-state fade-in">
    <h2>TRACE CORRUPTION</h2>
    <p>The requested story transmission was lost in the void.</p>
    <a routerLink="/" class="back-link">RETURN TO FEED</a>
  </div>
<!-- Floating Player -->
<div class="floating-player glass" *ngIf="story() && isTranscriptOpen()">
  <div class="float-controls">
    <button *ngIf="!tts.isPlaying()" (click)="readStory()" class="fab-btn glass" title="Listen">
      <span class="icon">▶</span>
    </button>

    <ng-container *ngIf="tts.isPlaying()">
      <button *ngIf="!tts.isPaused()" (click)="pauseStory()" class="fab-btn glass" title="Pause">
        <span class="icon">⏸</span>
      </button>
      <button *ngIf="tts.isPaused()" (click)="resumeStory()" class="fab-btn glass" title="Resume">
        <span class="icon">▶</span>
      </button>

      <div class="mini-progress">
        <span class="time">{{ formatTime(tts.currentTime()) }}</span>
        <div class="mini-track">
          <div class="mini-fill" [style.width.%]="tts.progress()"></div>
        </div>
      </div>

      <button (click)="stopStory()" class="fab-btn glass stop-btn" title="Stop">
        <span class="icon">⏹</span>
      </button>
    </ng-container>
  </div>
</div>
</div>