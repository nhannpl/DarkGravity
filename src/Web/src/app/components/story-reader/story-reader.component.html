<div class="reader-container">
  <div *ngIf="loading()" class="reader-skeleton fade-in">
    <div class="skeleton-title glass"></div>
    <div class="skeleton-line glass"></div>
    <div class="skeleton-line glass"></div>
    <div class="skeleton-line glass"></div>
  </div>

  <article *ngIf="!loading() && story()" class="story-trace fade-in">
    <header class="reader-header">
      <a routerLink="/" class="back-link">← RETURN TO FEED</a>
      
      <div class="metadata-bar">
        <span class="scary-tag" [attr.data-level]="getScaryLevel(story()!.scaryScore)">
          {{ getScaryLevel(story()!.scaryScore) }} ANOMALY
        </span>
        <span class="separator">/</span>
        <span class="author-tag">TRANSIMITTED BY: {{ story()!.author }}</span>
        <span class="separator">/</span>
        <span class="date-tag">{{ story()!.fetchedAt | date:'HH:mm:ss MMMM d, yyyy' }}</span>
      </div>

      <h1 class="story-title">{{ story()!.title }}</h1>
<div class="header-actions">
  <a [href]="story()!.url" target="_blank" class="source-link">
    <span class="source-tag" [attr.data-source]="getStorySource(story()!.url)">
      VIEW ORIGINAL ON {{ getStorySource(story()!.url) }} ↗
    </span>
  </a>
  <button class="action-btn-small glass">
    <span class="icon">★</span> SAVE TO SHADOWS
  </button>
</div>
    </header>

    <div class="ai-analysis-box glass">
      <div class="analysis-header">
        <span class="ai-icon">✧</span>
        AI INSIGHT (SOCRATES LITE)
      </div>
      <div class="analysis-text" [innerHTML]="story()!.aiAnalysis | markdown"></div>
      <div class="score-grid">
        <div class="score-item">
          <span class="label">SCARY SCORE</span>
          <span class="value">{{ story()!.scaryScore }}/10</span>
        </div>
        <div class="score-bar-container">
          <div class="score-bar" [style.width.%]="story()!.scaryScore * 10"></div>
        </div>
      </div>
    </div>

    <div *ngIf="videoEmbedUrl()" class="video-embed-container glass fade-in">
      <div class="video-wrapper">
        <iframe [src]="videoEmbedUrl()" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
        </iframe>
      </div>
    </div>
    
    <div class="transcript-toggle" (click)="toggleTranscript()" [class.open]="isTranscriptOpen()">
      <div class="content-label">
        <span class="label-icon">▤</span>
        {{ getStorySource(story()!.url) === 'YOUTUBE' ? 'DECRYPTED TRANSCRIPT' : 'ARCHIVED STORY LOG' }}
        <span class="dropdown-arrow">{{ isTranscriptOpen() ? '▼' : '▶' }}</span>
      </div>
    </div>
    
    <section class="story-body" *ngIf="isTranscriptOpen()">
      <p class="paragraph" *ngFor="let para of story()!.bodyText.split('\n')">
        {{ para }}
      </p>
    </section>

    <footer class="reader-footer">
      <div class="trace-end">END OF TRACE</div>
    </footer>
  </article>

  <div *ngIf="!loading() && !story()" class="error-state fade-in">
    <h2>TRACE CORRUPTION</h2>
    <p>The requested story transmission was lost in the void.</p>
    <a routerLink="/" class="back-link">RETURN TO FEED</a>
  </div>
</div>